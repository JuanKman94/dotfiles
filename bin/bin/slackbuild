#!/bin/bash
# Install package using SlackBuilds (R) method
#
# Usage: slackbuild <sb pkg>[.tar.gz]

# exit on error
set -e

ARCHIVE=$1
NAME="${ARCHIVE%.tar.gz}" # take an archive from slackbuilds.com
NAME="${NAME%/}"          # or a slackbuild package directory
RED='\033[0;31m'
RESET='\e[0m'

function print_error() {
    echo -e 1>&2 "${RED}$@${RESET}"
}

function print_help() {
    echo 1>&2 "Usage: $(basename $0) <slackbuild [.tar.gz]>"
    echo -ne 1>&2 "\nThe slackbuild can be either an archive downloaded from "
    echo -e 1>&2 "slackbuilds.org\nor a directory from the slackbuilds repository."
    exit 1
}

if [ ! -f "$ARCHIVE" -a ! -d "$NAME" ]; then
    print_error "Package not found."
    echo
    print_help
fi

[ -f "$ARCHIVE" ] && tar xf "$ARCHIVE"

cd $NAME
NAME="$(basename "$NAME")"

source $NAME.info

# check if DOWNLOAD_x86_64 is configured
if [ "$DOWNLOAD" == "UNSUPPORTED" -a -n "$DOWNLOAD_x86_64" ]; then
    DOWNLOAD="$DOWNLOAD_x86_64"
fi

if [ -z "$DOWNLOAD" ]; then
    print_error "No DOWNLOAD source"
    exit 1
fi

wget --continue $DOWNLOAD
if [ $? -ne 0 ]; then
    print_error "Something went wrong with wget"
    exit 1
fi

sudo bash "./${NAME}.SlackBuild"
sudo /sbin/upgradepkg --install-new /tmp/${PRGNAM}-*.tgz
